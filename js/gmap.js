jQuery(function ($) {
    if ($('#map').length) {
        initMap();
    }
    google_autocomlete()
});

var map, directionsService, directionsDisplay;
var poly_spb_kad, poly_VO, poly_Petro, poly_Left, poly_Right;
var order_route = [];
var poly_vars = [];
var polys = [];

// Санкт-Петербург
var poly_spb_kad_var = [[30.188008,59.984917],[30.192815,60.005382],[30.206204,60.013805],[30.224744,60.010539],[30.23161,60.013289],[30.221997,60.021195],[30.206891,60.027724],[30.211011,60.034768],[30.237446,60.029614],[30.248776,60.032363],[30.223714,60.05297],[30.250836,60.062754],[30.267316,60.061209],[30.304394,60.069961],[30.360699,60.089345],[30.375462,60.09106],[30.382672,60.082828],[30.386449,60.071677],[30.387479,60.065843],[30.392285,60.060351],[30.401211,60.055888],[30.411168,60.05297],[30.424557,60.050051],[30.43623,60.045415],[30.444127,60.036313],[30.452367,60.026522],[30.458546,60.020851],[30.470219,60.016211],[30.476399,60.011227],[30.480519,60.004522],[30.481206,59.996785],[30.488072,59.991453],[30.493565,59.987669],[30.504552,59.984745],[30.520344,59.982508],[30.54163,59.976658],[30.55399,59.971324],[30.557423,59.966332],[30.555707,59.957381],[30.54678,59.947049],[30.54266,59.936713],[30.538197,59.928787],[30.530301,59.918791],[30.528927,59.903446],[30.529614,59.896893],[30.527898,59.887404],[30.533734,59.876188],[30.534764,59.868247],[30.520001,59.85806],[30.511761,59.851152],[30.503178,59.84977],[30.486699,59.848733],[30.492879,59.84286],[30.504895,59.842169],[30.515538,59.838195],[30.520344,59.832665],[30.515195,59.827307],[30.486355,59.837849],[30.477772,59.850633],[30.46095,59.843205],[30.45271,59.835775],[30.443783,59.827653],[30.435887,59.823504],[30.394688,59.815897],[30.363446,59.81313],[30.35143,59.812265],[30.33289,59.807769],[30.316067,59.809498],[30.290729,59.824714],[30.274593,59.830764],[30.255367,59.829554],[30.234424,59.824195],[30.207301,59.821602],[30.138637,59.824023],[30.138637,59.834047],[30.125247,59.835084],[30.127994,59.849424],[30.129711,59.863455],[30.188008,59.984917]];

var poly_VO_var = [[30.259932,59.919203],[30.19573,59.933852],[30.177363,59.944791],[30.209978,59.962715],[30.230921,59.963404],[30.261648,59.956517],[30.282705,59.949543],[30.292834,59.94696],[30.312746,59.945152],[30.309313,59.941707],[30.277413,59.932008]];
var poly_Petro_var = [[30.318068,59.947178],[30.294893,59.947006],[30.224009,59.967573],[30.208732,59.968004],[30.211135,59.978406],[30.250274,59.982277],[30.275336,59.980909],[30.292674,59.982888],[30.320826,59.978672],[30.329974,59.973584],[30.335468,59.965494],[30.337528,59.956628],[30.340617,59.95358]];
var poly_Left_var = [[30.260967,59.91671],[30.268863,59.921537],[30.274528,59.929551],[30.288947,59.934117],[30.30474,59.938941],[30.334781,59.950136],[30.358814,59.951428],[30.36658,59.951686],[30.380313,59.955474],[30.390441,59.957971],[30.402343,59.952117],[30.395476,59.926276],[30.413624,59.910701],[30.438344,59.900009],[30.451218,59.87827],[30.459801,59.871366],[30.477654,59.868173],[30.4907,59.861353],[30.491902,59.852804],[30.467698,59.848832],[30.457055,59.840626],[30.435597,59.823602],[30.411221,59.818934],[30.386502,59.814785],[30.355603,59.814093],[30.341183,59.80951],[30.326077,59.8083],[30.308739,59.81271],[30.281617,59.828961],[30.265481,59.832072],[30.2375,59.825417],[30.207459,59.813228],[30.169522,59.799565],[30.156991,59.795932],[30.139138,59.800516],[29.999564,59.846184],[30.094321,59.884858],[30.211051,59.91935]];
var poly_Right_var = [[30.494196,59.851365],[30.493681,59.859396],[30.491278,59.863108],[30.483038,59.86682],[30.470335,59.870187],[30.461752,59.871646],[30.448191,59.884159],[30.443674,59.895462],[30.433321,59.903485],[30.412722,59.913171],[30.397444,59.927477],[30.404311,59.95478],[30.38663,59.95908],[30.371352,59.951633],[30.344401,59.952451],[30.339766,59.95555],[30.337534,59.959166],[30.333071,59.971129],[30.31848,59.979905],[30.295477,59.983346],[30.27814,59.981453],[30.240717,59.981712],[30.195742,59.976894],[30.157462,59.982572],[29.98005,59.990276],[29.945031,60.028782],[29.951897,60.042523],[30.035668,60.047331],[30.158578,60.0669],[30.190163,60.087829],[30.261574,60.104973],[30.366631,60.096059],[30.384484,60.089201],[30.402729,60.060378],[30.454228,60.041836],[30.48444,60.009535],[30.502293,59.98813],[30.562718,59.973333],[30.537312,59.910633],[30.535252,59.882703],[30.537999,59.864406],[30.506413,59.843527]];

var poly_var = [[30.59123028299004,59.8102578682166],[30.58848370095892,59.80766367750143],[30.582647214142106,59.80610706583567],[30.574750790802515,59.8038584980096],[30.569257626739923,59.800571855920296],[30.565481076447202,59.79711188148346],[30.56067455789232,59.79538175918632],[30.555181393829855,59.79572779085035],[30.543508420196883,59.80212872690363],[30.531148801056048,59.803512550991876],[30.52325237771646,59.801609778013095],[30.518102536407582,59.80299362371174],[30.5122660495914,59.807490724251316],[30.502996335235984,59.805934104482176],[30.498876462189013,59.80264766768939],[30.496129880157973,59.79797690886189],[30.492696652618637,59.793997596507914],[30.486516843048562,59.79347852064424],[30.465917477814475,59.78794120707327],[30.458021054474454,59.77842179438259],[30.442571530548634,59.78084517614369],[30.43673504373215,59.78049898956],[30.428495297638438,59.778941105338326],[30.41613567849778,59.77634446947069],[30.40446270486481,59.77530575837063],[30.391073117462426,59.77340137044845],[30.376996884552074,59.77305510638687],[30.36292065164188,59.77305510638687],[30.345067868438935,59.77651758483441],[30.33236492654477,59.779633507325045],[30.324125180450853,59.7772100372794],[30.30009258767743,59.77946040817755],[30.290502978488743,59.782861728783],[30.27711339108656,59.7847655751454],[30.268186999484833,59.78597705699119],[30.252737475559012,59.78580399085843],[30.231451464816455,59.78199630802319],[30.23351140134014,59.77455275996556],[30.226644946262205,59.77437963437702],[30.221151782199307,59.775418374394576],[30.19196934811731,59.767627033648424],[30.14699406735611,59.75498386649246],[30.12055821530503,59.75377125565357],[30.11128850094959,59.75533031862048],[30.094122363254357,59.76139264729209],[30.079702807590216,59.76450998644849],[30.070089770480475,59.77057064347195],[30.05292363278524,59.762778167407824],[30.035414172336115,59.76364408819221],[30.023585366409993,59.76838688968982],[30.032500644706325,59.77152847142944],[30.037650486015355,59.77516423116711],[30.041083713554464,59.77931889865029],[30.041427036308406,59.78381920286533],[30.034217258475838,59.78849195119879],[30.047263523124613,59.80371709227838],[30.05412997820298,59.81288341498452],[30.062369724296488,59.81755207878188],[30.064086338066538,59.82204720889248],[30.066146274589844,59.82567744671157],[30.06168307878898,59.83483771063116],[30.059623142265675,59.843131617464906],[30.048980136894407,59.84624129808865],[30.03936709978497,59.8486597370544],[30.042113681816218,59.85297793951697],[30.047606845878224,59.8581590403752],[30.04829787494756,59.86081352243898],[30.0565376210413,59.861504219422486],[30.074047081490527,59.86081352243898],[30.090526573678027,59.86167689141998],[30.10425948383428,59.862712904518354],[30.11455916645145,59.862712904518354],[30.12176894428348,59.86133154652566],[30.131725304146787,59.859777449982474],[30.13041523280408,59.85094580962742],[30.1256087142494,59.84610908873996],[30.1256087142494,59.84161721636873],[30.123548777725965,59.837124735784045],[30.123548777725965,59.83366856758022],[30.123548777725965,59.82779225554026],[30.119428904679097,59.822606410355135],[30.119428904679097,59.81499903874389],[30.131101878311892,59.81050295452709],[30.13796833339003,59.80600626171291],[30.14689472499158,59.800125052719835],[30.1585676986244,59.79597298435013],[30.171957286026732,59.79943307733631],[30.176763804581437,59.80150896023703],[30.179167063858763,59.80306578731916],[30.181913645889985,59.80687105758997],[30.19015339198377,59.80920589404665],[30.198393138077535,59.80981119524682],[30.20525959315565,59.81292399857251],[30.215902598526736,59.8175926566573],[30.22311237635877,59.82156914411316],[30.23615864100721,59.82433511541977],[30.24954822840952,59.828137949734476],[30.259504588272847,59.8298663668065],[30.267744334366586,59.83211317444362],[30.27735737147592,59.831940348490534],[30.282507212784466,59.8310762051951],[30.287657054093142,59.827792255531264],[30.296926768448607,59.82105049883201],[30.309629710343156,59.81534486616037],[30.315466197159513,59.81223228969422],[30.31889942469857,59.81033001604848],[30.321302683975947,59.80842763347149],[30.32988575282358,59.808946475876155],[30.336752207901693,59.80808173400649],[30.342588694718152,59.81084882875642],[30.354261668350972,59.81361569302432],[30.36387470546033,59.81292399857251],[30.371771128800173,59.81326984759445],[30.381040843155642,59.81188642987378],[30.38790729823378,59.81499903874389],[30.40370014491347,59.81707394927607],[30.418463023331423,59.82001318398493],[30.4387190658119,59.825026572235316],[30.445585520890013,59.82986636680645],[30.451078684952527,59.8347054558167],[30.4576018172767,59.841271662515204],[30.460005076554076,59.84403599244061],[30.47373798671033,59.840234979424054],[30.49124744715956,59.83228599949672],[30.501547129776704,59.82813794973442],[30.509100230362627,59.82502657222631],[30.514593394425145,59.82675515127727],[30.521974833634072,59.83073054156314],[30.527038844254196,59.83289088008955],[30.53210285487432,59.83159469385771],[30.543432505753298,59.830212039401744],[30.548494865726052,59.83313680304845],[30.55330138428073,59.835037770559964],[30.557421257327597,59.8326183384662],[30.55810790283541,59.828124639486376],[30.558794548343222,59.82570470343215],[30.56085448486668,59.82293884622331],[30.570467521976042,59.82034564582512],[30.579737236331507,59.8167148250228],[30.58729033691746,59.814466975112325],[30.589006950686972,59.811008447405925],[30.59123028299004,59.8102578682166]];
poly_vars.push(poly_var);
poly_var = [[30.438958595005744,60.042380247047056],[30.430718848912033,60.04598636945167],[30.41938919803308,60.04976378817867],[30.41286606570886,60.05113728747881],[30.404454658238432,60.05319742891588],[30.395528266636756,60.057317324812765],[30.389348457066355,60.06092181047491],[30.385915229527424,60.06812959682845],[30.382825324741876,60.07636513255381],[30.381108710972974,60.08142553196805],[30.379392097203,60.085284634877475],[30.376302192417658,60.08777137215788],[30.37338394900949,60.09068661755732],[30.367204139439416,60.09403025696719],[30.359307716099497,60.094716089646454],[30.349351356236397,60.09625916081416],[30.337678382603425,60.0964306086909],[30.33046860477132,60.09625916081416],[30.320512244908013,60.09625916081416],[30.31227249881448,60.09797359930514],[30.30780930301359,60.098316476308035],[30.306436011997995,60.101230785911696],[30.306436011997995,60.10363061138149],[30.30540604373642,60.10723002071274],[30.304719398228606,60.11031491462324],[30.307122657505783,60.11374223450909],[30.309869239537232,60.11665517502365],[30.316735694615343,60.118025881093224],[30.326692054478467,60.11973918316301],[30.337335059849813,60.11973918316301],[30.34763474246696,60.11922520193585],[30.358964393346138,60.11922520193585],[30.370980689732697,60.11922520193585],[30.382996986119256,60.11939652990643],[30.390206763951365,60.11973918316301],[30.398103187291337,60.117340535215476],[30.400849769322505,60.11391359110876],[30.41011948367797,60.1104862891174],[30.416985938755985,60.11031491462324],[30.42144913455677,60.10911526810766],[30.425912330357505,60.10380202077454],[30.432778785435517,60.0974592772007],[30.431405494419845,60.08631365249636],[30.43758530399035,60.07482112676837],[30.435868690220506,60.071561320792355],[30.43552536746684,60.0671000097986],[30.44548172733004,60.06263809339405],[30.45440811893159,60.06195159097778],[30.464021156040896,60.060921810484075],[30.48221726199776,60.0614367047614],[30.492173621861316,60.06298133922793],[30.49698014041597,60.05714567279427],[30.498696754185385,60.04907701702699],[30.49148697635348,60.04049116808733],[30.48565048953702,60.033620876028095],[30.478440711704913,60.03310554632185],[30.468141029087818,60.031215935055876],[30.46814169964014,60.02333553544502],[30.469514990655533,60.0222186287676],[30.48238959392713,60.02058615857378],[30.48685278972779,60.017492835283555],[30.505907202569663,60.01130531729144],[30.50642218670045,60.00606220528095],[30.518781805841286,59.99737915299481],[30.521871710626325,59.99419766045081],[30.51809516033327,59.992047829548845],[30.515863562433044,59.990671864220616],[30.512773657647752,59.98903783083141],[30.510713721124368,59.98645761328304],[30.508653784600885,59.98508141472742],[30.507280493585057,59.98422126147513],[30.505735541192667,59.983103028717395],[30.50178732952285,59.98336108579495],[30.49577918132931,59.98482337110672],[30.491315985528704,59.98662963406519],[30.487196112481787,59.988779818158825],[30.482732916680924,59.99178984042254],[30.47998633464988,59.99454162038962],[30.47775473674917,60.00460086149643],[30.476724768487642,60.00683583163047],[30.47483649334108,60.01104747881674],[30.469514990655533,60.01474297072605],[30.464880133477877,60.01689132201568],[30.46007361492279,60.01878175527747],[30.454237128106865,60.02264821273153],[30.449430609552337,60.02651421638413],[30.44479575237412,60.0321835342634],[30.442735815850764,60.03330010303337],[30.44239249309705,60.03604841869143],[30.441534186212213,60.03776599947712],[30.440332556573537,60.03922587268741],[30.43930258831201,60.04059981186085],[30.438958595005744,60.042380247047056]];
poly_vars.push(poly_var);
poly_var = [[30.096837470739114,59.99150904195056],[30.09649414798522,59.993916882480136],[30.09649414798522,59.99615257698917],[30.097524116246923,59.998388119924094],[30.098554084508653,60.002858751099474],[30.099584052770357,60.005609607429456],[30.10267395755552,60.00904785502643],[30.106450507848496,60.01231385803421],[30.111257026403177,60.01403267697872],[30.115033576696153,60.015407667581975],[30.122243354528184,60.01729818597406],[30.133916328161003,60.015407667581975],[30.14799256107115,60.01231385803421],[30.157948920934427,60.01145441494004],[30.17408509036803,60.00509383935388],[30.185414741246934,60.0042342079601],[30.186788032262555,59.9987320361535],[30.1895346142938,59.99219701432666],[30.185414741246934,59.988068964792205],[30.185414741246934,59.98411243247363],[30.1833548047235,59.98153182963541],[30.16000885745786,59.979639259261106],[30.133916328161003,59.98325225395583],[30.116750190465694,59.98531664472001],[30.099584052770357,59.98841298865428],[30.096837470739114,59.99150904195056]];
poly_vars.push(poly_var);
poly_var = [[30.50779480716454,59.98376836319964],[30.510541389195787,59.986348791100696],[30.514661262242758,59.98927303205312],[30.520497749059267,59.99202502201968],[30.52255768558227,59.99443282487757],[30.529767463414377,59.99804419954887],[30.539723823278138,60.00543768507577],[30.546590278356177,60.00784450860795],[30.562383125035762,60.011798194308845],[30.575429389684356,60.01403267642002],[30.59019226810244,60.011798194308845],[30.597745368688265,60.00956356067231],[30.604955146520247,60.0061253668761],[30.607358405797598,59.9927129836322],[30.612508247106273,59.984628528260785],[30.617314765660925,59.97774657976841],[30.62006134769217,59.96053542750272],[30.606671760289785,59.94951557994091],[30.598432014196074,59.943315299796694],[30.596028754918724,59.9376306874534],[30.591908881871777,59.930911248477976],[30.58469910403985,59.91884729065056],[30.58744568607112,59.91453766759698],[30.58744568607112,59.91057231847788],[30.59293885013356,59.8953961595049],[30.59122223636417,59.89022087828713],[30.59019226810244,59.87969531167069],[30.586072395055496,59.87106530328112],[30.577489326207868,59.84861676001142],[30.585042426793766,59.84170645761448],[30.59019226810224,59.83462190367607],[30.580922553746824,59.829609964382946],[30.56959290286787,59.8268444325227],[30.565816352574895,59.82770868597837],[30.564786384313166,59.83462190367607],[30.556889960973372,59.83721398911339],[30.5489935376334,59.83704118971659],[30.54006714603188,59.83634998312994],[30.533887336461373,59.83652278612628],[30.528050849644938,59.83859635189722],[30.51740784427395,59.84084256860141],[30.50916809817996,59.844989030731256],[30.502988288609785,59.84740756099357],[30.496808479039508,59.85034411069253],[30.49886841556302,59.85328040041718],[30.50401825687182,59.85466209386492],[30.50951142093398,59.85604372974585],[30.51603455325838,59.85794338508833],[30.521871040074814,59.86156969763012],[30.5277075268913,59.86450499347903],[30.53148407718379,59.865886219240934],[30.533887336461373,59.8688211328904],[30.53457398196911,59.87227363976529],[30.53354401370756,59.87538058843787],[30.53148407718379,59.87848724580012],[30.528394172398755,59.88349180330014],[30.528394172398755,59.88797800519758],[30.5277075268913,59.89211857531484],[30.5277075268913,59.895913643128765],[30.5277075268913,59.90022569218672],[30.5277075268913,59.90453717958806],[30.527364204137584,59.91384807639668],[30.528050849645396,59.91919203683352],[30.530797431676618,59.92281164857638],[30.534230659215673,59.925396843016195],[30.536290595739107,59.92884345457139],[30.537663886754757,59.93211740279256],[30.53972382327819,59.9357355999553],[30.541097114293812,59.939008865671255],[30.54281372806333,59.94176504853436],[30.54453034183287,59.94555442465609],[30.545903632848493,59.95020442871952],[30.549336860387548,59.95295967785856],[30.552083442418795,59.95674777019566],[30.553800056188336,59.9596746348955],[30.556203315465687,59.962601240200506],[30.556203315465687,59.96759308591623],[30.554830024450066,59.97086319629741],[30.54968018314147,59.97396089678662],[30.541097114293812,59.97688623585807],[30.529767463414913,59.979811315626215],[30.51740784427428,59.98256409502035],[30.51157135745787,59.98290817629587],[30.50779480716454,59.98376836319964]];
poly_vars.push(poly_var);




/*
// Нева
var poly_neva_1_var = [[30.508322,59.843532],[30.495275,59.848542],[30.493731,59.8602],[30.484289,59.866761],[30.476908,59.869],[30.461287,59.871417],[30.448927,59.881945],[30.444292,59.895252],[30.436224,59.902496],[30.419229,59.910347],[30.402833,59.921368],[30.395909,59.929635],[30.398312,59.934976],[30.401746,59.938939],[30.404149,59.948037],[30.40535,59.954065],[30.400544,59.957508],[30.385094,59.959144],[30.37943,59.956217],[30.379344,59.956475],[30.372048,59.95329],[30.364838,59.951998],[30.356299,59.952383],[30.339304,59.953588],[30.322138,59.948594],[30.315615,59.945925],[30.30583,59.941111],[30.297076,59.938183],[30.287806,59.93534],[30.277678,59.933273],[30.271498,59.929568],[30.267893,59.924657],[30.265662,59.919572],[30.260397,59.917774],[30.245529,59.920357],[30.218406,59.928112],[30.205532,59.930008],[30.207935,59.919064],[30.260607,59.916149],[30.268668,59.920506],[30.274326,59.929687],[30.281272,59.932577],[30.28856,59.933744],[30.323713,59.946178],[30.345475,59.951031],[30.364797,59.950664],[30.372883,59.952253],[30.385796,59.957324],[30.39536,59.956111],[30.402522,59.95266],[30.399582,59.940142],[30.391643,59.929311],[30.396363,59.923413],[30.414558,59.910924],[30.434126,59.902061],[30.442364,59.893816],[30.447337,59.881808],[30.460372,59.869952],[30.476831,59.8679],[30.484342,59.86483],[30.491468,59.859468],[30.490958,59.851332],[30.493198,59.845335],[30.508322,59.843532]];
// Малая Нева
var poly_neva_2_var = [[30.310546,59.945109],[30.293594,59.946277],[30.278059,59.950152],[30.272136,59.952262],[30.261751,59.956065],[30.252052,59.95826],[30.239263,59.95882],[30.232397,59.962435],[30.206905,59.961876],[30.208536,59.969019],[30.225702,59.96704],[30.241924,59.961252],[30.264025,59.957001],[30.274046,59.953585],[30.28441,59.950512],[30.293873,59.947165],[30.315599,59.946567],[30.310546,59.945109]];

// Большая Нева
var poly_neva_3_var = [[30.339957,59.952684],[30.335966,59.95764],[30.335708,59.961815],[30.335107,59.965603],[30.331417,59.970422],[30.326181,59.976129],[30.319443,59.978817],[30.304809,59.981334],[30.291892,59.982323],[30.275026,59.980903],[30.266786,59.982065],[30.260091,59.982452],[30.245071,59.981764],[30.230394,59.979957],[30.218978,59.978107],[30.20413,59.976],[30.203615,59.977118],[30.237175,59.981204],[30.24962,59.982452],[30.254942,59.982624],[30.261794,59.982688],[30.267959,59.982237],[30.275341,59.981334],[30.28461,59.982839],[30.294137,59.983592],[30.304523,59.982452],[30.321088,59.979484],[30.328126,59.976086],[30.333362,59.971654],[30.336538,59.965803],[30.337217,59.960535],[30.340177,59.955237],[30.345883,59.951401],[30.339957,59.952684]];
*/
function initMap() { //30.328228,59.939784
    var spb = {lat: 59.939784, lng: 30.328228};

    map = new google.maps.Map(document.getElementById('map'), {
        center: spb,
        scrollwheel: true,
        zoom: 10
    });

    directionsDisplay = new google.maps.DirectionsRenderer({
        map: map,
        polylineOptions: {
            strokeColor: "#000099",
            strokeOpacity: 0.5
        }
    });
    directionsService = new google.maps.DirectionsService();


    poly_spb_kad = CratePoly(poly_spb_kad_var, map, '#00FF00');
    poly_VO = CratePoly(poly_VO_var, map, '#ffe708');
    poly_Petro = CratePoly(poly_Petro_var, map, '#d300d6');
    poly_Left = CratePoly(poly_Left_var, map, '#622c09');
    poly_Right = CratePoly(poly_Right_var, map, '#86ffe4');

    $.each( poly_vars, function( key, value ) {
        polys.push(CratePoly(value, map, '#000674'));
    });

    // poly_neva_1 = CratePoly(poly_neva_1_var, map, '#0000FF');
    // poly_neva_2 = CratePoly(poly_neva_2_var, map, '#0000FF');
    // poly_neva_3 = CratePoly(poly_neva_3_var, map, '#0000FF');
    var order_id = $('#order_id').val();
    if (order_id > 0) {
        calc_route();
    }
}

function CratePoly(poly_arr,map, color){
    var points = ArrayToCoords(poly_arr);
    var poly = new google.maps.Polygon({
        paths: points,
        strokeColor: color,
        strokeOpacity: 0.05,
        strokeWeight: 2,
        fillColor: color,
        fillOpacity: 0.05
    });
    poly.setMap(map);
    return poly;
}

function ArrayToCoords(arr){
    var points = [];
    for (var i = 0; i < arr.length; i++) {
        points.push({
            lat: arr[i][1],
            lng: arr[i][0]
        });
    }
    return points;
}

function calc_route() {
    // Удаляем старые маршруты
    $.each(order_route, function () {
        this.setMap(null);
    });
    var way_points = [];
    var i = 0;
    $('.spb-streets').each(function () {
        // Адреса доставки
        var route_address = $(this).val();
        var route_to_house = $(this).parent().parent().find('.to_house').val();
        // var route_to_corpus = $(this).parent().parent().find('.to_corpus').val();
        var route_to_corpus = '';
        if (route_address !== '') {
            route_address = (route_address.indexOf(',') > -1) ? 'Ленинградская обл., ' + route_address : 'Ленинградская обл., Санкт-Петербург, ' + route_address;
            way_points.push({
                location: (route_address + ((route_to_house !== '') ? (', ' + route_to_house) : '') + ((route_to_corpus !== '') ? (', ' + route_to_corpus) : '')) + '',
                stopover: true
            });
            i++;
        }
    });

    if (i === 0) {
        bootbox.alert('Необходимо ввести хотя бы один адрес доставки.');
        return false;
    }
    // Начальная точка маршрута
    var origin_point = ($("SELECT.store_address").val() !== '0')?$("SELECT.store_address option:selected").text():$('INPUT.store_address_new').val();
    // Конечная точка маршрута
    // var destination_point = route[route.length-1].location;
    // Исклюаем конечную точку маршрута из промежуточных
    var destination_point = way_points.pop();

    if (origin_point === ''){
        origin_point = way_points.pop();
        origin_point = (typeof origin_point !== 'undefined') ? origin_point.location : '';
    }else{
        origin_point = (origin_point.indexOf(',') > -1) ? 'Ленинградская обл., ' + origin_point : 'Ленинградская обл., Санкт-Петербург, ' + origin_point;
    }
    if ( origin_point !== '' ) {
        directionsService.route({
            origin: origin_point,
            destination: destination_point.location,
            waypoints: way_points,
            region: 'ru',
            provideRouteAlternatives: true,
            optimizeWaypoints: true,
            avoidHighways: true,
            avoidTolls: true,
            travelMode: google.maps.TravelMode.WALKING
            // travelMode: google.maps.TravelMode.DRIVING
        }, function (response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                var routeIndex = getShortestRoute(response);
                directionsDisplay.setDirections(response);
                // Set route index
                directionsDisplay.setOptions({
                    routeIndex: routeIndex
                });
                var route = response.routes[routeIndex];
                var summaryPanel = document.getElementById('viewContainer');
                summaryPanel.innerHTML = '';
                var shortInfo = '';
                var delivery_sum = 0;
                // For each route, display summary information.
                for (var i = 0; i < route.legs.length; i++) {
                    var distanceInSPb = 0;
                    var distanceOutSideSPb = 0;
                    var neva_cross = false;
                    var end_in_geozone = false;
                    var neva_path = [];
                    for (var k = 0; k < route.legs[i].steps.length; k++) {
                        var outside_path = [];
                        var inside_path = [];
                        var points_count = 0;
                        for (var z = 0; z < route.legs[i].steps[k].lat_lngs.length; z++) {
                            var way_latlangs = route.legs[i].steps[k].lat_lngs[z];
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_spb_kad)) {
                                inside_path.push(way_latlangs);
                            } else {
                                outside_path.push(way_latlangs);
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_VO)) {
                                neva_path.push('VO');
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_Petro)) {
                                neva_path.push('Petro');
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_Left)) {
                                neva_path.push('Left');
                            }
                            if (google.maps.geometry.poly.containsLocation(way_latlangs, poly_Right)) {
                                neva_path.push('Right');
                            }
                            points_count = z;
                        }



                        if (outside_path.length > 0) {
                            var polyline_out = new google.maps.Polyline({
                                map: map, path: outside_path,
                                strokeColor: "#d60005", strokeOpacity: 0.8, strokeWeight: 3
                            });
                            distanceOutSideSPb += google.maps.geometry.spherical.computeLength(polyline_out.getPath());
                            // Записываем маршрут в массив для очистки
                            order_route.push(polyline_out);
                        }
                        if (inside_path.length > 0) {
                            var polyline_in = new google.maps.Polyline({
                                map: map, path: inside_path,
                                strokeColor: "#04d622", strokeOpacity: 0.8, strokeWeight: 2
                            });
                            distanceInSPb += google.maps.geometry.spherical.computeLength(polyline_in.getPath());
                            // Записываем маршрут в массив для очистки
                            order_route.push(polyline_in);
                        }
                    }
                    // Проверка попадания последней точки маршрута в геозону за КАДом
                    var end_way_latlang = route.legs[i].end_location;
                    $.each( polys, function( key, poly_out_kad ) {
                        if (google.maps.geometry.poly.containsLocation(end_way_latlang, poly_out_kad)) {
                            end_in_geozone = true;
                        }
                    });

                    // iLog(neva_path.getUnique());
                    // iLog(neva_path.getUnique().length);
                    // Если мы сменили за путь несколько районов, то мы пересекали Неву
                    if (neva_path.getUnique().length > 1) {
                        neva_cross = true;
                    }
                    var moveList = '';
                    var cost_km = 0;
                    var cost_km_out = 0;
                    var cost_Neva = 0;
                    var cost_Geozone = 0; // Геозоны за пределами КАД по единому тарифу
                    var routeSegment = i + 1;

                    if (route.legs.length > 1) {
                        if (routeSegment > 1) {
                            summaryPanel.innerHTML += '<hr/>';
                            shortInfo += '<hr/>';
                            var beetween_point = Math.ceil(MetersToKilo(distanceInSPb) + MetersToKilo(distanceOutSideSPb));
                            if (beetween_point > 8){
                                bootbox.alert('Расстояние между пунктами доставки не может превышать 8 км. Ваше расстояние ' +
                                    beetween_point + ' км. Вам необходимо создать отдельный заказ на данный маршрут.');
                                $('.btn-submit').attr('disabled','disabled');
                            }else{
                                $('.btn-submit').removeAttr('disabled');
                            }
                        }
                        summaryPanel.innerHTML += '<b>' + routeSegment + ': </b>';
                        shortInfo += '<b>' + routeSegment + ': </b>'
                    }

                    if (distanceInSPb > 0) {
                        cost_km = getRoutePrice(MetersToKilo(distanceInSPb));
                        moveList += ' город: ' + MetersToKilo(distanceInSPb) + ' км (' + cost_km + ' р)' + '<br/>';
                        shortInfo += '<b>' + MetersToKilo(distanceInSPb) + ' км</b><br/>'
                    }
                    if (neva_cross) {
                        cost_Neva = $('input#km_neva').val();
                        moveList += ' Нева: ' + cost_Neva + ' р<br/>';
                        // shortInfo += '<i>+ ' + cost_Neva + ' р</i><br/>'
                    }
                    if (end_in_geozone) {
                        cost_Geozone = $('input#km_geozone').val();
                        moveList += ' За КАД: ' + cost_Geozone + ' р<br/>';
                    }
                    if (distanceOutSideSPb > 0) {
                        // Если конечная точка попадает в Геозону, то обнуляем стоимсоть за КАДом
                        cost_km_out = !end_in_geozone?getOutKADprice(MetersToKilo(distanceOutSideSPb)):0;
                        moveList += ' за городом: ' + MetersToKilo(distanceOutSideSPb) + ' км (' + cost_km_out + ' р) ' + '<br/>';
                        shortInfo += '<i>' + MetersToKilo(distanceOutSideSPb) + ' км</i><br/>'
                    }

                    // Если установлена фиксированная стоимость по городу, то ставим ее вместо расчетной
                    var fixprice_inside = $('#user_fix_price').val();
                    var cost_in_spb = (fixprice_inside == 0)?(parseFloat(cost_km) + parseFloat(cost_Neva)):fixprice_inside;

                    // Устанавливаем стоимость по маршруту и выполняем перерасчет
                    var cost_route = $('.cost_route').eq(i).get();
                    $(cost_route).val(parseFloat(cost_in_spb) + parseFloat(cost_km_out) + parseFloat(cost_Geozone));
                    re_calc(cost_route);

                    // summaryPanel.innerHTML += 'От: ' + route.legs[i].start_address + ',<br>';
                    // summaryPanel.innerHTML += 'До: ' + route.legs[i].end_address + '<br>';
                    summaryPanel.innerHTML += moveList + '<br>';

                    delivery_sum += parseFloat(cost_in_spb) + parseFloat(cost_km_out) + parseFloat(cost_Geozone);
                }
                $('#ShortInfo').html(shortInfo);

                $('.delivery_sum').html('<b>Итоговая сумма доставки заказа: ' + delivery_sum + '.00 руб</b>');
            } else {
                bootbox.alert('Ошибка построения маршрута: ' + status);
            }
        });
    }
}

function MetersToKilo(number){
    return Math.ceil(number / 100)/10;
}

function getRoutePrice(km_route){
    var cost_res = 0;
    $('input.km_cost').each(function(){
        var km_from = $(this).attr('km_from');
        var km_to = $(this).attr('km_to');
        var km_cost = $(this).val();
        if (km_route >= km_from && km_route < km_to ){
            cost_res = km_cost;
        }
    });
    return Math.ceil(cost_res);
}

function getOutKADprice(dist){
    var cost_km_kad = $('input#km_kad').val();
    return Math.ceil(dist*cost_km_kad);
}

Array.prototype.getUnique = function(){
    var u = {}, a = [];
    for(var i = 0, l = this.length; i < l; ++i){
        if(u.hasOwnProperty(this[i])) {
            continue;
        }
        a.push(this[i]);
        u[this[i]] = 1;
    }
    return a;
};

function getShortestRoute(response){
    var shortest = Number.MAX_VALUE;
    var routeIndex = 0;
    response.routes.forEach(function(rou, index) {
        if (rou.legs[0].distance.value < shortest) {
            shortest = rou.legs[0].distance.value  ;
            routeIndex = index;
        }
    });
    return routeIndex;
}

function iLog(text) {
    console.log(text);
}
